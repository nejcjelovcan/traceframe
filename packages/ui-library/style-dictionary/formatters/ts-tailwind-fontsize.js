/**
 * Style Dictionary formatter for Tailwind fontSize TypeScript.
 * Generates a TS file with Tailwind-compatible fontSize definitions
 * in the format: [fontSize, { lineHeight }] as const tuples.
 *
 * Supports $default: true to add a DEFAULT entry.
 */

// Style Dictionary metadata keys to skip when traversing tokens
const SD_METADATA_KEYS = new Set([
  'value',
  'path',
  'name',
  'attributes',
  'original',
  'filePath',
  'isSource',
])

function isTokenKey(key) {
  return !key.startsWith('$') && !SD_METADATA_KEYS.has(key)
}

export default function tsTailwindFontSizeFormatter({ dictionary }) {
  const fontSizeTokens = dictionary.tokens.fontSize
  if (!fontSizeTokens) {
    return 'export default {} as const\n'
  }

  const entries = []
  let defaultEntry = null

  for (const [key, token] of Object.entries(fontSizeTokens)) {
    if (!isTokenKey(key) || typeof token !== 'object') {
      continue
    }

    const fontSize = token.$value ?? token.value
    const lineHeight = token.$lineHeight

    if (fontSize === undefined) {
      continue
    }

    // Tailwind fontSize format: [size, { lineHeight }] as const
    let value
    if (lineHeight !== undefined) {
      value = `['${fontSize}', { lineHeight: '${lineHeight}' }] as const`
    } else {
      value = `'${fontSize}'`
    }

    entries.push(`  '${key}': ${value}`)

    // Track default for later
    if (token.$default === true) {
      defaultEntry = `  DEFAULT: ${value}`
    }
  }

  // Add DEFAULT entry if a token was marked as default
  if (defaultEntry) {
    entries.push(defaultEntry)
  }

  let output = '// Auto-generated by Style Dictionary - do not edit\n\n'
  output += 'const fontSize = {\n'
  output += entries.join(',\n')
  output += ',\n}\n\n'
  output += 'export default fontSize\n'

  return output
}
