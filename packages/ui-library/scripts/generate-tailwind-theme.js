#!/usr/bin/env node
/**
 * Generate a Tailwind CSS v4 @theme inline block from generated JSON token files.
 *
 * Tailwind v4 uses CSS-first configuration. This script reads the JSON token files
 * produced by Style Dictionary and generates a CSS file with @theme inline declarations.
 * Using "inline" mode avoids creating CSS custom properties that would conflict with
 * our existing token CSS variables.
 */
import { readFileSync, writeFileSync } from 'node:fs'
import { dirname, join } from 'node:path'
import { fileURLToPath } from 'node:url'

const __dirname = dirname(fileURLToPath(import.meta.url))
const generatedDir = join(__dirname, '..', 'src', 'styles', 'generated')

function readJson(filename) {
  return JSON.parse(readFileSync(join(generatedDir, filename), 'utf-8'))
}

/**
 * Flatten a nested color object into --color-key entries.
 * E.g., { surface: { DEFAULT: "rgb(...)", muted: "rgb(...)" } }
 * becomes: { "--color-surface": "rgb(...)", "--color-surface-muted": "rgb(...)" }
 */
function flattenColors(obj, prefix = '--color') {
  const entries = []
  for (const [category, variants] of Object.entries(obj)) {
    if (typeof variants === 'string') {
      // Flat entry
      entries.push([`${prefix}-${category}`, variants])
    } else {
      // Nested object with variants
      for (const [variant, value] of Object.entries(variants)) {
        if (variant === 'DEFAULT') {
          entries.push([`${prefix}-${category}`, value])
        } else {
          entries.push([`${prefix}-${category}-${variant}`, value])
        }
      }
    }
  }
  return entries
}

function generateThemeCSS() {
  const lines = ['/* Generated by scripts/generate-tailwind-theme.js - do not edit */', '@theme inline {']

  // Colors
  const colors = readJson('tailwind-colors.json')
  const colorEntries = flattenColors(colors)
  lines.push('  /* Colors */')
  for (const [key, value] of colorEntries) {
    lines.push(`  ${key}: ${value};`)
  }

  // Spacing
  const spacing = readJson('tailwind-spacing.json')
  lines.push('')
  lines.push('  /* Spacing */')
  for (const [key, value] of Object.entries(spacing)) {
    lines.push(`  --spacing-${key}: ${value};`)
  }

  // Sizing (width + height)
  const sizing = readJson('tailwind-sizing.json')
  lines.push('')
  lines.push('  /* Sizing (width & height) */')
  for (const [key, value] of Object.entries(sizing)) {
    lines.push(`  --width-size-${key}: ${value};`)
    lines.push(`  --height-size-${key}: ${value};`)
  }

  // Border radius
  const radius = readJson('tailwind-radius.json')
  lines.push('')
  lines.push('  /* Border radius */')
  for (const [key, value] of Object.entries(radius)) {
    if (key === 'DEFAULT') {
      // v4 doesn't have a DEFAULT radius concept in @theme - skip
      // (DEFAULT maps to --radius which is the bare "rounded" class)
      continue
    }
    lines.push(`  --radius-${key}: ${value};`)
  }

  // Shadows
  const shadows = readJson('tailwind-shadows.json')
  lines.push('')
  lines.push('  /* Shadows */')
  for (const [key, value] of Object.entries(shadows)) {
    lines.push(`  --shadow-${key}: ${value};`)
  }

  // Font families
  const fonts = readJson('tailwind-fonts.json')
  lines.push('')
  lines.push('  /* Font families */')
  for (const [key, value] of Object.entries(fonts)) {
    lines.push(`  --font-${key}: ${value};`)
  }

  // Font sizes
  const fontSizes = readJson('tailwind-font-sizes.json')
  lines.push('')
  lines.push('  /* Font sizes */')
  for (const [key, value] of Object.entries(fontSizes)) {
    if (Array.isArray(value)) {
      lines.push(`  --font-size-${key}: ${value[0]};`)
      if (value[1] && value[1].lineHeight) {
        lines.push(`  --font-size-${key}--line-height: ${value[1].lineHeight};`)
      }
    } else {
      lines.push(`  --font-size-${key}: ${value};`)
    }
  }

  // Animations
  lines.push('')
  lines.push('  /* Animations */')
  lines.push('  --animate-collapsible-down: collapsible-down 200ms ease-out;')
  lines.push('  --animate-collapsible-up: collapsible-up 200ms ease-out;')

  lines.push('}')

  // Keyframes (outside @theme)
  lines.push('')
  lines.push('@keyframes collapsible-down {')
  lines.push("  from { height: 0; }")
  lines.push("  to { height: var(--radix-collapsible-content-height); }")
  lines.push('}')
  lines.push('')
  lines.push('@keyframes collapsible-up {')
  lines.push("  from { height: var(--radix-collapsible-content-height); }")
  lines.push("  to { height: 0; }")
  lines.push('}')
  lines.push('')

  const output = lines.join('\n')
  const outputPath = join(generatedDir, 'tailwind-theme.css')
  writeFileSync(outputPath, output)
  console.log(`âœ“ Generated ${outputPath}`)
}

generateThemeCSS()
